<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3</title>
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="d3.v4.js"/>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
</head>
<body>
<script>
    var w = 700;
    var h = 450;
    var margin = {
        top: 60,
        bottom: 80,
        left: 120,
        right: 80
    };
    var width = w - margin.left - margin.right;
    var height = h - margin.top - margin.bottom;
    var svg = d3.select("body").append("svg")
        .attr("id", "chart")
        .attr("width", w)
        .attr("height", h);
    var chart = svg.append("g")
        .classed("display", true)
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scaleLinear()
        .range([0, width]);
    var y = d3.scaleLinear()
        .domain([1, 5])
        .range([height, 0]);

    var tickValues = [18, 25, 32, 39, 46, 53, 60, 67, 74];

    var xAxis = d3.axisBottom(x)
        .tickValues(tickValues);

    var yAxis = d3.axisLeft(y)
        .ticks(5)
        .tickSize(20)
        .tickFormat(function (d) {
            return d.toFixed(1);
        });

    var responseScale = d3.scaleLinear()
        .range([2, 15]);

    var yGridLines = d3.axisLeft(y)
        .tickSize(-width, 0, 0)
        .tickFormat("");

    var xGridLines = d3.axisBottom(x)
        .tickValues(tickValues)
        .tickSize(-height, 0, 0)
        .tickFormat("");

    var ordinalColorScale = d3.scaleOrdinal(d3.schemeCategory10);

    let drawAxis = function (params) {
        if (params.initialize == true) {

            this.append("g")
                .classed("gridline x", true)
                .attr("transform", "translate(0," + height + ")")
                .call(params.axis.gridlines.x);

            this.append("g")
                .classed("gridline y", true)
                .attr("transform", "translate(0,0)")
                .call(params.axis.gridlines.y);


            this.append("g")
                .classed("x axis", true)
                .attr("transform", "translate(0," + height + ")")
                .call(params.axis.x);

            this.append("g")
                .classed("y axis", true)
                .attr("transform", "translate(0,0)")
                .call(params.axis.y);

            this.select(".y.axis")
                .append("text")
                .classed("y axis-label", true)
                .attr("transform", "translate(" + -56 + "," + height / 2 + ") rotate(-90)")
                .text("Rating (1=Low, 5=High)");

            this.select(".x.axis")
                .append("text")
                .classed("x axis-label", true)
                .attr("transform", "translate(" + width / 2 + "," + 48 + ")")
                .text("Customer age");

            this.append("g")
                .append("text")
                .classed("chart-header", true)
                .attr("transform", "translate(20,-20)")
                .style("fill", "#000")
                .text("");
        }
    };

    function plot(params) {
        var self = this;

        x.domain(d3.extent(params.data, function (d) {
            return d.age;
        }));
        responseScale.domain(d3.extent(params.data, function (d) {
            return d.responses;
        }))

        var donuts = d3.keys(params.data[0]).filter(function (d) {
            return d !== 'age' && d !== 'responses';
        });

        drawAxis.call(this, params);

        //Enter phase for groups
        this.selectAll('.donut')
            .data(donuts)
            .enter()
            .append("g")
            .attr("class", function (d) {
                return d;
            })
            .classed("donut", true);
        //Update phase for group
        this.selectAll('.donut')
            .style("fill", function (d, i) {
                return ordinalColorScale(i);
            })
            .on("mouseover", function (d, i) {
                d3.select(this)
                    .transition()
                    .style("opacity", 1);
            })
            .on("mouseout", function (d, i) {
                d3.select(this)
                    .transition()
                    .style("opacity", 0.1);
            });
        ;

        donuts.forEach(function (donut) {
            var g = self.selectAll("g." + donut);
            var arr = params.data.map(function (d) {
                return {
                    key: donut,
                    value: d[donut],
                    age: d.age,
                    responses: d.responses
                }
            });
            //enter()
            g.selectAll(".response")
                .data(arr)
                .enter()
                .append("circle")
                .classed("response", true);
            // update
            g.selectAll(".response")
                .attr("r", function (d) {
                    return responseScale(d.responses);
                })
                .attr("cx", function (d) {
                    return x(d.age);
                })
                .attr("cy", function (d) {
                    return y(d.value);
                })
                .on("mouseover", function (d, i) {
                    var str = d.key + " Donut : ";
                    str += " Age: " + d.age;
                    str += " Responses: " + d.responses;
                    str += " Average rating: " + d.value;
                    d3.select(".chart-header").text(str);
                })
                .on("mouseout", function (d, i) {
                    d3.select(".chart-header").text("");
                });
            //exit()
            g.selectAll(".response")
                .data(arr)
                .exit()
                .remove();

        });
    }

    d3.csv("data.csv", function (error, parsedData) {
        plot.call(chart, {
            data: parsedData,
            axis: {
                x: xAxis,
                y: yAxis,
                gridlines: {
                    x: xGridLines,
                    y: yGridLines
                }
            },
            initialize: true
        });
    });


</script>
</body>
</html>